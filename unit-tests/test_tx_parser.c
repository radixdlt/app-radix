#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>
#include <stdint.h>
#include <stdbool.h>
#include <string.h>

#include <cmocka.h>

static void test_parse_tx(void **state) {
    (void) state;

    transaction_t tx;

    // Hex string for transaction below:
    // 0x0a000104374c00efbe61f645a8b35d7746e106afa7422877e5d607975b6018e0a1aa6bf0000000040921000000000000000000000000000000000000000000000000000000000000000002010301040377bac8066e51cd0d6b320c338d5abbcdbcca25572b6b3eee9443eafc92106bba000000000000000000000000000000000000000000000001158e460913cffffe000500000003010301040377bac8066e51cd0d6b320c338d5abbcdbcca25572b6b3eee9443eafc92106bba0000000000000000000000000000000000000000000000008ac7230489e7fffe0104040377bac8066e51cd0d6b320c338d5abbcdbcca25572b6b3eee9443eafc92106bba02f19b2d095a553f3a41da4a8dc1f8453dfbdc733c5aece8b128b7d7999ae247a50000000000000000000000000000000000000000000000008ac7230489e8000000

    // String representation of instructions of transaction below:
    //
    // Instructions:
    // |- HEADER(0, 1)
    // |- DOWN(SubstateId { hash:
    // 0x374c00efbe61f645a8b35d7746e106afa7422877e5d607975b6018e0a1aa6bf0, index: 4 })
    // |- SYSCALL(0x000000000000000000000000000000000000000000000000000000000000000002)
    // |- UP(Tokens { rri: 0x01, owner:
    // 0x040377bac8066e51cd0d6b320c338d5abbcdbcca25572b6b3eee9443eafc92106bba, amount: U256 { raw:
    // 19999999999999999998 } })
    // |- END
    // |- LDOWN(3)
    // |- UP(Tokens { rri: 0x01, owner:
    // 0x040377bac8066e51cd0d6b320c338d5abbcdbcca25572b6b3eee9443eafc92106bba, amount: U256 { raw:
    // 9999999999999999998 } })
    // |- UP(PreparedStake { owner:
    // 0x040377bac8066e51cd0d6b320c338d5abbcdbcca25572b6b3eee9443eafc92106bba, delegate:
    // 0x02f19b2d095a553f3a41da4a8dc1f8453dfbdc733c5aece8b128b7d7999ae247a5, amount: U256 { raw:
    // 10000000000000000000 } })
    // |- END

    // Further prettified human readable  representation of instructions of tx below:
    // Instructions:
    // |- HEADER(0, 1)
    // |- DOWN(SubstateId { hash:
    // 0x374c00efbe61f645a8b35d7746e106afa7422877e5d607975b6018e0a1aa6bf0, index: 4 })
    // |- SYSCALL(0x000000000000000000000000000000000000000000000000000000000000000002)
    // |
    // |- UP(Tokens {
    // |--- rri: xrd_rb1qya85pwq,
    // |--- owner: brx1qsph0wkgqeh9rngddveqcvudt2aum0x2y4tjk6e7a62y86hujggxhws07tsg3,
    // |--- amount: 19.0000
    // |- })
    // |
    // |- END
    // |- LDOWN(3)
    // |
    // |- UP(Tokens {
    // |--- rri: xrd_rb1qya85pwq,
    // |--- owner: brx1qsph0wkgqeh9rngddveqcvudt2aum0x2y4tjk6e7a62y86hujggxhws07tsg3,
    // |--- amount: 9.0000
    // |- })
    // |
    // |- UP(PreparedStake {
    // |--- owner: brx1qsph0wkgqeh9rngddveqcvudt2aum0x2y4tjk6e7a62y86hujggxhws07tsg3,
    // |--- delegate: vb1qtcektgftf2n7wjpmf9gms0cg57lhhrn83dwe6939zma0xv6ufr62ry5ycv,
    // |--- amount: 10.0000
    // |- })
    // |
    // |- END

    // clang-format off
	uint8_t raw_tx[] = {
		// Instruction 'HEADER' (#3 bytes)
		0x0a, 0x00, 0x01,
		
		// Instruction 'DOWN' (#37 bytes)
		0x04, 0x37, 0x4c, 0x00, 0xef, 0xbe, 0x61, 0xf6,
		0x45, 0xa8, 0xb3, 0x5d, 0x77, 0x46, 0xe1, 0x06,
		0xaf, 0xa7, 0x42, 0x28, 0x77, 0xe5, 0xd6, 0x07,
		0x97, 0x5b, 0x60, 0x18, 0xe0, 0xa1, 0xaa, 0x6b,
		0xf0, 0x00, 0x00, 0x00, 0x04,

		// Instruction 'SYSCALL' (#35 bytes)
		0x09, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x02,

		// Instruction 'UP' (#69 bytes)
		// Substate type: 'TOKENS'
		0x01, 0x03, 0x01, 0x04, 0x03, 0x77, 0xba, 0xc8,
		0x06, 0x6e, 0x51, 0xcd, 0x0d, 0x6b, 0x32, 0x0c,
		0x33, 0x8d, 0x5a, 0xbb, 0xcd, 0xbc, 0xca, 0x25,
		0x57, 0x2b, 0x6b, 0x3e, 0xee, 0x94, 0x43, 0xea,
		0xfc, 0x92, 0x10, 0x6b, 0xba, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x01, 0x15, 0x8e, 0x46,
		0x09, 0x13, 0xcf, 0xff, 0xfe,

		// Instruction 'END' (#1 bytes)
		0x00,

		// Instruction 'LDOWN' (#5 bytes)
		0x05, 0x00, 0x00, 0x00, 0x03,

		// Instruction 'UP' (#69 bytes)
		// Substate type: 'TOKENS'
		0x01, 0x03, 0x01, 0x04, 0x03, 0x77, 0xba, 0xc8,
		0x06, 0x6e, 0x51, 0xcd, 0x0d, 0x6b, 0x32, 0x0c,
		0x33, 0x8d, 0x5a, 0xbb, 0xcd, 0xbc, 0xca, 0x25,
		0x57, 0x2b, 0x6b, 0x3e, 0xee, 0x94, 0x43, 0xea,
		0xfc, 0x92, 0x10, 0x6b, 0xba, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x8a, 0xc7, 0x23,
		0x04, 0x89, 0xe7, 0xff, 0xfe,

		// Instruction 'UP' (#101 bytes)
		// Substate type: 'PREPARED STAKE'
		0x01, 0x04, 0x04, 0x03, 0x77, 0xba, 0xc8, 0x06,
		0x6e, 0x51, 0xcd, 0x0d, 0x6b, 0x32, 0x0c, 0x33,
		0x8d, 0x5a, 0xbb, 0xcd, 0xbc, 0xca, 0x25, 0x57,
		0x2b, 0x6b, 0x3e, 0xee, 0x94, 0x43, 0xea, 0xfc,
		0x92, 0x10, 0x6b, 0xba, 0x02, 0xf1, 0x9b, 0x2d,
		0x09, 0x5a, 0x55, 0x3f, 0x3a, 0x41, 0xda, 0x4a,
		0x8d, 0xc1, 0xf8, 0x45, 0x3d, 0xfb, 0xdc, 0x73,
		0x3c, 0x5a, 0xec, 0xe8, 0xb1, 0x28, 0xb7, 0xd7,
		0x99, 0x9a, 0xe2, 0x47, 0xa5, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x8a, 0xc7, 0x23,
		0x04, 0x89, 0xe8, 0x00, 0x00,

		// Instruction 'END' (#1 bytes)
		0x00
	};

	

	// buffer_t buf = {.ptr = raw_tx, .size = sizeof(raw_tx), .offset = 0};

	// parser_status_e status = transaction_deserialize(&buf, &tx);

	// assert_int_equal(status, PARSING_OK);

	// Expected cost: 29999999999999999998
	// Expected tx fee: 2
	// Expected hash: 83f4544ff1fbabc7be39c6f531c3f37fc50e0a0b653afdb22cc9f8e8aa461fc9
	// Expected BIP32: m/44'/536'/2'/1/3
	// Expected INS: ['HEADER', 'DOWN', 'SYSCALL', 'UP', 'END', 'LDOWN', 'UP', 'UP', 'END']

	uint8_t output[300];
	int length = transaction_serialize(&tx, output, sizeof(output));
	assert_int_equal(length, sizeof(raw_tx));
	assert_memory_equal(raw_tx, output, sizeof(raw_tx));
}

int main() {
	const struct CMUnitTest tests[] = {cmocka_unit_test(test_parse_tx)};

	return cmocka_run_group_tests(tests, NULL, NULL);
}
